# Pre-commit hooks

This repository uses the Python package [`pre-commit`][pre-commit] to manage pre-commit hooks. Pre-commit hooks are
actions which are run automatically, typically on each commit, to perform some common set of tasks. For example, a
pre-commit hook might be used to run any code linting automatically, providing any warnings before code is committed,
ensuring that all of our code adheres to a certain quality standard.

```{contents}
:local:
:depth: 2
```

## Purpose

For this repository, we are using `pre-commit` for a number of purposes:

- Checking for any secrets being committed accidentally;
- Checking for any large files (over 5MB) being committed; and
- Cleaning Jupyter notebooks, which means removing all outputs and execution counts.

We have configured `pre-commit` to run automatically on _every commit_. By running on each commit, we ensure that
`pre-commit` will be able to detect all contraventions and keep our repo in a healthy state.

## Installation

In order for `pre-commit` to run, action is needed to configure it on your system.

- Install the `pre-commit` package into your Python environment from `requirements.txt`; and
- Run `pre-commit install` in your terminal to set-up `pre-commit` to run when code is _committed_.

## Using the `detect-secrets` pre-commit hook

We use [`detect-secrets`][detect-secrets] to check that no secrets are accidentally committed. This hook requires you
to generate a baseline file if one is not already present within the root directory. To create the baseline file, run
the following at the root of the repository:

```shell
detect-secrets scan > .secrets.baseline
```

Next, audit the baseline that has been generated by running:

```shell
detect-secrets audit .secrets.baseline
```

When you run this command, you'll enter an interactive console and be presented with a list of high-entropy string
and/or anything which _could_ be a secret, and asked to verify whether or not this is the case. By doing this, the hook
will be in a position to know if you're later committing any _new_ secrets to the repo and it will be able to alert you
accordingly.

### If `pre-commit` detects secrets during commit

If `pre-commit` detects any secrets when you try to create a commit, it will detail what it found and where to go to
check the secret.

If the detected secret is a false-positive, you should update the `.secrets.baseline` through the following steps:

- Run `detect-secrets scan --update .secrets.baseline` from the root folder in the terminal to index the
  false-positive(s);
- Next, audit all indexed secrets via `detect-secrets audit .secrets.baseline` (the same as during initial set-up, if a
  `.secrets.baseline` doesn't exist); and
- Finally, ensure that you commit the updated `.secrets.baseline` in the same commit as the false-positive(s) it has
  been updated for.

If the detected secret is actually a secret (or other sensitive information), remove the secret and re-commit. There is
no need to update the secrets baseline in this case.

If your commit contains a mixture of false-positives and actual secrets, remove the actual secrets first before
updating and auditing the secrets baseline.

## Keeping specific Jupyter notebook outputs

It may be necessary or useful to keep certain output cells of a Jupyter notebook, for example charts or graphs
visualising some set of data. To do this, add the following comment at the top of the input block:

```julia
# [keep_output]
```

This will tell the hook not to strip the resulting output of this cell, allowing it to be committed.

[detect-secrets]: https://github.com/Yelp/detect-secrets
[pre-commit]: https://pre-commit.com/
